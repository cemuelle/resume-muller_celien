<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="style.css">
  <title>CV</title>
  
  <script>
    // Theme
    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
    }
    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme') || 'auto';
      const next = current === 'dark' ? 'light' : 'dark';
      applyTheme(next);
    }
    (() => {
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      applyTheme(saved || (prefersDark ? 'dark' : 'light'));
    })();
  </script>
</head>

<body>
  <div class="cv-container">
    <div id="cv-root"></div>

    <footer>
      <small id="cv-footer"></small>
      <div>
        <button class="btn" id="btn-theme" onclick="toggleTheme()">üåì</button>
        <button class="btn" id="btn-lang" onclick="toggleLanguage()">üåê</button>
      </div>
      <div id="cv-error" style="color:#c0392b;"></div>
    </footer>
  </div>
</body>

<script>
  // i18n
  const SUPPORTED = ['fr', 'en', 'de'];
  const browserLang = navigator.language.slice(0, 2).toLowerCase();
  console.log('Browser language:', browserLang);

  let currentLang = localStorage.getItem('lang') || (SUPPORTED.includes(browserLang) ? browserLang : SUPPORTED[0]);

  let ICONS = {};

  async function loadIcons() {
    try {
      const res = await fetch('icons.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      ICONS = await res.json();
    } catch (e) {
      console.error('Impossible to load icons.json', e);
      ICONS = {};
    }
  }

  async function loadLanguage(lang) {
    try {
      const res = await fetch(`lang/lang-${lang}.json`, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      renderCV(data);
      localStorage.setItem('lang', lang);
      currentLang = lang;
      document.documentElement.lang = data.htmlLang || lang;
      document.getElementById('cv-error').textContent = '';
      alignTimelinePeriods();
    } catch (e) {
      document.getElementById('cv-error').textContent =
        'Impossible to load language file: ' + e.message;
      console.error(e);
    }
  }

  function toggleLanguage() {
    const idx = SUPPORTED.indexOf(currentLang);
    const next = SUPPORTED[(idx + 1) % SUPPORTED.length];
    loadLanguage(next);
  }

  // Renderers
  function htmlEscape(s) {
    return s.replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[m]));
  }

  function renderSection(section) {
    const title = `<h2>${htmlEscape(section.title)}</h2>`;
    if (section.type === 'badges') {
      const cls = section.className
        || (section.title.toLowerCase().includes('lang') ? 'langues' : 'competences');
      const items = (section.items || []).map(x => `<span>${htmlEscape(x)}</span>`).join('');
      return `${title}<div class="${cls}">${items}</div>`;
    }
    if (section.type === 'lines') {
      const lines = (section.items || []).map(x => `<div class="section">${x}</div>`).join('');
      return `${title}${lines}`;
    }
    if (section.type === 'section') {
      return `${title}<div class="section">${section.text || ''}</div>`;
    }
    if (section.type === 'list') {
      const items = (section.items || [])
        .map(x => `<li>${x}</li>`)
        .join('');
      return `${title}<ul>${items}</ul>`;
    }
    if (section.type === 'timeline') {
    const rows = (section.items || []).map(it =>
      `<div class="timeline-row">
        <div class="timeline-period"><b>${htmlEscape(it.period || '')}</b></div>
        <div class="timeline-text">${it.text || ''}</div>
      </div>`
    ).join('');
    return `${title}<div class="timeline">${rows}</div>`;
  }
    return '';
  }

  function renderCV(data) {
    document.title = data.docTitle || ('CV - ' + data.name);
    const links = (data.links || []).map(l => {
      const iconDef = ICONS[l.icon];
      const icon = iconDef ? `<svg width="20" height="20" viewBox="${iconDef.viewBox}" fill="currentColor" style="margin-right:6px;"><path d="${iconDef.path}"/></svg>` : '';
      const label = htmlEscape(l.label || l.url);
      const url = l.url || '#';
      return `<div><a href="${url}" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;display:inline-flex;align-items:center;">${icon}${label}</a></div>`;
    }).join('');

    if (Array.isArray(data.info) && data.info.length > 0) {
      const infoLines = data.info.map(item => {
        const label = htmlEscape(item.label || '');
        const value = item.value || '';
        if (!value) return '';

        let formattedValue = value;
        if (item.type === 'email') formattedValue = `<a href="mailto:${value}">${value}</a>`;
        else if (item.type === 'tel') formattedValue = `<a href="tel:${value.replace(/\s+/g, '')}">${value}</a>`;
        else if (item.type === 'url') formattedValue = `<a href="${value}" target="_blank" rel="noopener">${value}</a>`;

        return `<div><b>${label}</b> ${formattedValue}</div>`;
      }).join('');

      infoHTML = `
        <div class="personal-info">
          ${data.photo ? `<img src="${data.photo}" alt="${htmlEscape(data.name)}" class="cv-photo">` : ''}
          <div>${infoLines}</div>
        </div>`;
    }

    const html = `
        <h1>${htmlEscape(data.name || '')}</h1>
        ${infoHTML}
        <div class="title-description">${data.title_description || ''}</div>
        ${data.adjectives ? `<div class="adjectives">${data.adjectives}</div>` : ''}
        <div class="infos">${links}</div>
        ${(data.sections || []).map(renderSection).join('')}
      `;
    document.getElementById('cv-root').innerHTML = html;

    document.getElementById('cv-footer').textContent = data.footer || '';
    document.getElementById('btn-theme').textContent = data.theme_button || 'üåì';
    document.getElementById('btn-lang').textContent = data.lang_button || 'üåê';
  }

  function alignTimelinePeriods() {
    const periods = document.querySelectorAll('.timeline-period');
    if (!periods.length) return;

    let maxWidth = 0;
    periods.forEach(p => {
      const width = p.offsetWidth;
      if (width > maxWidth) maxWidth = width;
    });

    periods.forEach(p => {
      p.style.display = 'inline-block';
      p.style.width = maxWidth + 'px';
    });
  }
  // boot
  loadIcons();
  loadLanguage(currentLang);
</script>

</html>